
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../user_guide/">
      
      <link rel="icon" href="../images/cyclone_black.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.3">
    
    
      
        <title>Getting Started - Ciclo</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c4a75a56.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../style.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#getting-started" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ciclo" class="md-header__button md-logo" aria-label="Ciclo" data-md-component="logo">
      
  <img src="../images/cyclone_white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ciclo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Getting Started
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/cgarciae/ciclo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ciclo" class="md-nav__button md-logo" aria-label="Ciclo" data-md-component="logo">
      
  <img src="../images/cyclone_white.png" alt="logo">

    </a>
    Ciclo
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/cgarciae/ciclo" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Getting Started
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation-and-usage" class="md-nav__link">
    Installation and usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-dataset" class="md-nav__link">
    Create a dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-model" class="md-nav__link">
    Create a model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-the-state" class="md-nav__link">
    Define the state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-a-training-procedure" class="md-nav__link">
    Define a training procedure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-training-loop" class="md-nav__link">
    The training loop
  </a>
  
    <nav class="md-nav" aria-label="The training loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schedules" class="md-nav__link">
    Schedules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callbacks" class="md-nav__link">
    Callbacks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-tracking" class="md-nav__link">
    Time tracking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collecting-values-from-history" class="md-nav__link">
    Collecting values from history
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../user_guide/" class="md-nav__link">
        User Guide
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installation-and-usage" class="md-nav__link">
    Installation and usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-dataset" class="md-nav__link">
    Create a dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-model" class="md-nav__link">
    Create a model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-the-state" class="md-nav__link">
    Define the state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-a-training-procedure" class="md-nav__link">
    Define a training procedure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-training-loop" class="md-nav__link">
    The training loop
  </a>
  
    <nav class="md-nav" aria-label="The training loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schedules" class="md-nav__link">
    Schedules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#callbacks" class="md-nav__link">
    Callbacks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-tracking" class="md-nav__link">
    Time tracking
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collecting-values-from-history" class="md-nav__link">
    Collecting values from history
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<style>
.md-grid {
    max-width: 100%;
    /* add 5% padding left and right*/
    padding: 0 5%;
}
</style>

<h1 id="getting-started">Getting Started</h1>
<p><code>ciclo</code> is a functional library for training loops in JAX. It provides a set of utilities and abstractions to build complex training loops with any JAX framework. <code>ciclo</code> defines a set of building blocks that naturally compose together so they can scale up to build higher-level abstractions.</p>
<p>In this guide we will learn how to use <code>ciclo</code> to train a simple model on the MNIST dataset.</p>
<h3 id="installation-and-usage">Installation and usage</h3>
<p>You can install <code>ciclo</code> from pypi:
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>ciclo
</code></pre></div></p>
<p>To use <code>ciclo</code> you tipically the main module as it exposes most of the API:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">ciclo</span>
</code></pre></div>
<h3 id="create-a-dataset">Create a dataset</h3>
<p>To begin with our example, first we will load the MNIST using TensorFlow Datasets and create a <code>tf.data.Dataset</code> that we will use to train our model.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="nn">tfds</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>

<span class="n">ds_train</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="n">tfds</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;mnist&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">shuffle_files</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds_train</span> <span class="o">=</span> <span class="n">ds_train</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<h3 id="create-a-model">Create a model</h3>
<p>Next we will create a linear classifier. Here we will be using Flax but you can use any JAX framework.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">flax.linen</span> <span class="k">as</span> <span class="nn">nn</span>

<span class="k">class</span> <span class="nc">Classifier</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="nd">@nn</span><span class="o">.</span><span class="n">compact</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">255.0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># flatten</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<h3 id="define-the-state">Define the state</h3>
<p>Ciclo promotes grouping all the state such as parameters, optimizer state, random state, etc, into a single pytree structure we refer to as <code>state</code>. While state could be something as simple as a <code>dict</code>, since Flax also uses this pattern and provides a <code>TrainState</code> abstraction we will be using in this here.</p>
<p>Next we will instantiated the model, initialized its parameters, and constructed our state object using <code>TrainState</code>. <code>TrainState</code> will internally initialize the optimizer state using <code>optax</code>.</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">optax</span>
<span class="kn">from</span> <span class="nn">flax.training.train_state</span> <span class="kn">import</span> <span class="n">TrainState</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">()</span>
<span class="n">variables</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">TrainState</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">apply_fn</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">],</span>
    <span class="n">tx</span><span class="o">=</span><span class="n">optax</span><span class="o">.</span><span class="n">adamw</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
If you are using other frameworks like Haiku or Equinox, feel free to leverage <code>TrainState</code> nevertheless as its API shoud be compatible with any JAX framework.</p>
<h3 id="define-a-training-procedure">Define a training procedure</h3>
<p>For the training procedure we will create a <code>train_step</code> function that takes the <code>state</code> and a <code>batch</code> of data with the goal of updating the <code>state</code> and capturing some <code>logs</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">TrainState</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_fn</span><span class="p">({</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">])</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">optax</span><span class="o">.</span><span class="n">softmax_cross_entropy_with_integer_labels</span><span class="p">(</span>
            <span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span><span class="p">,</span> <span class="n">logits</span>

    <span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">logits</span><span class="p">),</span> <span class="n">grads</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">value_and_grad</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">,</span> <span class="n">has_aux</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">state</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="n">grads</span><span class="o">=</span><span class="n">grads</span><span class="p">)</span>
    <span class="c1"># log metrics</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">logs</span><span class="p">()</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">logs</span><span class="p">,</span> <span class="n">state</span>
</code></pre></div>
<p>A couple of things are happening here:</p>
<ul>
<li><code>.apply_gradients</code> is a method from <code>TrainState</code> that is updating the parameters and optimizer state using the gradients.</li>
<li>We are using <code>ciclo.logs</code> to create a dictionary structure that will hold the metrics.</li>
</ul>
<p>As we will see in the following section, the specific signature of <code>train_step</code> chosen here guarantees that its compatible with <code>ciclo.loop</code> and other utilities.</p>
<h3 id="the-training-loop">The training loop</h3>
<p>To define training loops Ciclo provides utilities like schedules, callbacks, logging, and time tracking. These can be used either with <code>ciclo.loop</code> or manually.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">loop</label><label for="__tabbed_1_2">manual</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><code>ciclo.loop</code> offers a compact way of defining training loops by mapping schedules to callbacks. It takes an initial state and a dataset, and iterates over the dataset while updating the state with the callbacks until a stop condition is met.</p>
<div class="highlight"><pre><span></span><code><span class="n">total_steps</span> <span class="o">=</span> <span class="mi">5_000</span>

<span class="n">state</span><span class="p">,</span> <span class="n">history</span><span class="p">,</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span>
    <span class="n">state</span><span class="p">,</span> <span class="c1"># State</span>
    <span class="n">ds_train</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">(),</span> <span class="c1"># Iterable[Batch]</span>
    <span class="p">{</span>
        <span class="c1"># Schedule: List[Callback]</span>
        <span class="n">ciclo</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="p">[</span><span class="n">train_step</span><span class="p">],</span>
        <span class="n">ciclo</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span> <span class="p">[</span>
            <span class="n">ciclo</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;logdir/model&quot;</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">ciclo</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span> <span class="p">[</span><span class="n">ciclo</span><span class="o">.</span><span class="n">keras_bar</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">)],</span>
    <span class="p">},</span>
    <span class="n">stop</span><span class="o">=</span><span class="n">ciclo</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">total_steps</span><span class="p">),</span> <span class="c1"># Period</span>
<span class="p">)</span>
</code></pre></div>
<p>On every step, <code>loop</code> will go over all the schedules in order and check whether the current step matches the schedule, if it does, it will call the callbacks associated with the schedule. Each callback can update the state, add logs, or merely produce side effects (e.g. logging or checkpointing). <code>loop</code> will continue iterating until the stop condition is met or the dataset terminates.</p>
</div>
<div class="tabbed-block">
<p>Manual iteration is a little bit more verbose but you get full control.</p>
<div class="highlight"><pre><span></span><code><span class="n">total_steps</span> <span class="o">=</span> <span class="mi">5_000</span>

<span class="n">call_checkpoint</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">every</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="c1"># Schedule</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;logdir/model&quot;</span><span class="p">)</span> <span class="c1"># Callback</span>
<span class="n">keras_bar</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">keras_bar</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total_steps</span><span class="p">)</span> <span class="c1"># Callback</span>
<span class="n">end_period</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">total_steps</span><span class="p">)</span> <span class="c1"># Period</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">history</span><span class="p">()</span> <span class="c1"># History</span>
<span class="c1"># (Elapsed, Batch)</span>
<span class="k">for</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">elapse</span><span class="p">(</span><span class="n">ds_train</span><span class="o">.</span><span class="n">as_numpy_iterator</span><span class="p">(),</span> <span class="n">stop</span><span class="o">=</span><span class="n">end_period</span><span class="p">):</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">ciclo</span><span class="o">.</span><span class="n">logs</span><span class="p">()</span> <span class="c1"># Logs</span>
    <span class="c1"># update logs and state</span>
    <span class="n">logs</span><span class="o">.</span><span class="n">updates</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
    <span class="c1"># periodically checkpoint state</span>
    <span class="k">if</span> <span class="n">call_checkpoint</span><span class="p">(</span><span class="n">elapsed</span><span class="p">):</span>
        <span class="n">checkpoint</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="c1"># serialize state</span>

    <span class="n">keras_bar</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">logs</span><span class="p">)</span> <span class="c1"># update progress bar</span>
    <span class="n">history</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">elapsed</span><span class="p">,</span> <span class="n">logs</span><span class="p">)</span> <span class="c1"># commit logs to history</span>
</code></pre></div>
<p>Here we are showing a somewhat equivalent version to what <code>loop</code> produces, however it could be simplified a bit.</p>
</div>
</div>
</div>
<h4 id="schedules">Schedules</h4>
<p>Schedules are used to determine when certain events should occure. In this example, we are using <code>ciclo.every</code> which can periodically trigger based on a given number of steps, samples seen, or time passed. In this case, we are calling <code>train_step</code> on every step and <code>ciclo.checkpoint</code> every 1000 steps.</p>
<h4 id="callbacks">Callbacks</h4>
<p>Callbacks are used to perform useful actions such as logging, checkpointing, early stopping, etc. In this example, we are using <code>ciclo.keras_bar</code> to display a progress bar and <code>ciclo.checkpoint</code> to serialize the state. <code>loop</code> accepts as a calback any object that implements the <code>LoopCallback</code> protocol or functions of the form:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># variadic: accepts between 0 and 4 arguments</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span>
    <span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">loop_state</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">logs</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">state</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">logs</span> <span class="o">|</span> <span class="n">state</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>
<p>In our example, <code>train_step</code> is a valid callback because it accepts <code>state</code> and <code>batch</code> as inputs, and returns <code>logs</code> and <code>state</code> as outputs, thus matching one of the possible signatures. If your function doesn't match any of the signatures, <code>loop</code> wont raise immediatly but you will get a runtime error later when the callback is called.</p>
<h4 id="logging">Logging</h4>
<p>Ciclo provides two basic logging utilities, <code>ciclo.logs</code> and <code>ciclo.history</code>. <code>logs</code> is a custom nested dictionary structure that can be used to store metrics and other information, it has some convenience properties and methods to facilitate organizing information (e.g. <code>add_metric</code>), merging logs between different callbacks (<code>merge</code>, <code>updates</code>) and lookup nested values (e.g. <code>entry_value</code>). <code>history</code> is a list of <code>logs</code> that can be used to collect logs. <code>loop</code> will automatically <code>merge</code> the logs from all callbacks and <code>commit</code> them to the <code>history</code> at the end each step.</p>
<h4 id="time-tracking">Time tracking</h4>
<p>Ciclo provides a <code>ciclo.elapse</code> generator that yields an <code>(elapsed, batch)</code> tuple for each batch in the dataset. <code>elapsed</code> is a pytree structure that contains information about the current iteration of the loop, number of samples seen, and amount of time passed since the start of the loop. Ciclo also provides the <code>ciclo.at</code> utility to create a <code>Period</code> object that can be used to determine when a certain amount of steps/samples/time has passed.</p>
<h3 id="collecting-values-from-history">Collecting values from history</h3>
<p>After training, we can collect the values from the <code>history</code> and plot them. For this we can use the <code>collect</code> method that takes some key names as inputs and returns the list of values for each key for timesteps in which they <strong>all</strong> appear in the logs.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># collect metric values</span>
<span class="n">steps</span><span class="p">,</span> <span class="n">losses</span><span class="p">,</span> <span class="n">accuracies</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">losses</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">accuracies</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Accuracy&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p>Even though <code>logs</code> are nested dictionary structures, <code>collect</code> lets us specify just the names of the inner most keys and it will search for them, in case there is a clash and they appear more than once you will get an error, to fix it you will have to specify the full path instead e.g. <code>"metrics.accuracy"</code>. Note that the keys from <code>elapsed</code> are available in the logs as well, this is how we are able to collect the <code>steps</code>.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
    
  </body>
</html>